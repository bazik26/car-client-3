<section class="car" *ngIf="car() as current">
  <div class="container car__header">
    <div>
      <a routerLink="/catalog" class="car__breadcrumb">← Вернуться к каталогу</a>
      <h1>{{ current.brand }} {{ current.model }} {{ current.year }}</h1>
      <p>{{ current.description || 'Автомобиль прошёл комплексную проверку и готов к доставке.' }}</p>
    </div>
    <div class="car__pricing glass-card">
      <span class="car__pricing-label">Стоимость под ключ</span>
      <strong>{{ current.price | currency:'RUB':'symbol-narrow':'1.0-0' }}</strong>
      <div class="car__pricing-meta">
        <span>С учётом доставки и растаможки</span>
        <span>Можно зарезервировать на 3 дня</span>
      </div>
      <button class="btn-primary" type="button" (click)="modalService.openContactModal()">Забронировать автомобиль</button>
    </div>
  </div>

  <div class="container car__gallery">
    <div class="car__gallery-main glass-card"
         (touchstart)="onTouchStart($event)"
         (touchend)="onTouchEnd($event)">
      <button type="button" 
              class="car__gallery-nav car__gallery-nav--prev"
              (click)="prevImage()"
              *ngIf="gallery().length > 1"
              aria-label="Предыдущее изображение">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <img 
        [ngSrc]="heroImage()" 
        width="940" 
        height="540" 
        [alt]="current.brand + ' ' + current.model" 
        class="car__gallery-image"
        (error)="onImageError(activeImage())">
      <button type="button" 
              class="car__gallery-nav car__gallery-nav--next"
              (click)="nextImage()"
              *ngIf="gallery().length > 1"
              aria-label="Следующее изображение">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
      <div class="car__gallery-counter" *ngIf="gallery().length > 1">
        {{ activeImage() + 1 }} / {{ gallery().length }}
      </div>
    </div>
    <div class="car__gallery-thumbs">
      <button type="button"
              *ngFor="let image of gallery(); let idx = index"
              [class.active]="idx === activeImage()"
              [class.error]="imageErrors().has(idx)"
              (click)="selectImage(idx)"
              [attr.aria-label]="'Изображение ' + (idx + 1)">
        <img 
          [ngSrc]="imageErrors().has(idx) ? '/assets/placeholder/car-dark.svg' : image" 
          width="220" 
          height="140" 
          [alt]="current.brand + ' ' + (idx + 1)"
          (error)="onImageError(idx)">
      </button>
    </div>
  </div>

  <div class="container car__meta">
    <section class="glass-card car__specs">
      <header>
        <h2>Технический паспорт</h2>
        <span>ID #{{ current.id }}</span>
      </header>
      <div class="car__specs-grid">
        <div>
          <span>Кузов</span>
          <strong>{{ current.bodyType || 'седан / хэтчбек' }}</strong>
        </div>
        <div>
          <span>Двигатель</span>
          <strong>{{ current.engine ? (current.engine + ' л') : 'не указан' }}</strong>
        </div>
        <div>
          <span>Мощность</span>
          <strong>{{ current.powerValue ? (current.powerValue + ' л.с.') : '—' }}</strong>
        </div>
        <div>
          <span>Коробка</span>
          <strong>{{ current.gearbox || '—' }}</strong>
        </div>
        <div>
          <span>Привод</span>
          <strong>{{ current.drive || '—' }}</strong>
        </div>
        <div>
          <span>Пробег</span>
          <strong>{{ current.mileage ? (current.mileage | number) + ' км' : '—' }}</strong>
        </div>
        <div>
          <span>VIN</span>
          <button class="btn-primary btn-vin" type="button" (click)="modalService.openContactModal()">Запросить VIN</button>
        </div>
        <div>
          <span>Дата обновления</span>
          <strong>{{ current.updatedAt | date:'d MMMM yyyy' }}</strong>
        </div>
      </div>
    </section>

    <section class="glass-card car__features" *ngIf="featureGroups().length">
      <h2>Опции и комплектация</h2>
      <div class="car__feature-group" *ngFor="let group of featureGroups()">
        <h3>{{ group.title }}</h3>
        <ul>
          <li *ngFor="let feature of group.features">{{ feature }}</li>
        </ul>
      </div>
    </section>
  </div>

  <div class="container car__cta glass-card">
    <div>
      <h2>Хотите такой же автомобиль?</h2>
      <p>Подготовим индивидуальные варианты, расчёт доставки и прозрачный бюджет. Менеджер свяжется в течение часа.</p>
    </div>
    <div class="car__cta-contacts">
      <button class="btn-primary" type="button" (click)="modalService.openContactModal()">Связаться с нами</button>
      <div>
        <span>{{ brand.phone }}</span>
        <span>{{ brand.email }}</span>
      </div>
    </div>
  </div>
</section>
