<!-- Chat Widget -->
<div class="chat-widget" [class.open]="isOpen()">
  <!-- Chat Toggle Button -->
  <button 
    class="chat-toggle" 
    (click)="toggleChat()"
    [class.connected]="isConnected()"
    [class.has-messages]="messages().length > 0"
    [class.open]="isOpen()"
    [title]="isOpen() ? 'Закрыть чат' : 'Открыть чат'">
    <span class="chat-logo" *ngIf="!isOpen()">{{ getBrandLogo() }}</span>
    <svg *ngIf="isOpen()" class="close-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
    </svg>
    <span class="chat-badge" *ngIf="messages().length > 0 && !isOpen()">{{ messages().length }}</span>
  </button>

  <!-- Chat Window -->
  <div class="chat-window" *ngIf="isOpen()">
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="chat-title">
        <i class="fas fa-headset"></i>
        <span>Поддержка</span>
        <div class="connection-status" [class.connected]="isConnected()">
          <i class="fas fa-circle"></i>
          <span>{{ isConnected() ? 'Онлайн' : 'Подключение...' }}</span>
        </div>
      </div>
      <div class="chat-controls">
        <button 
          class="sound-toggle" 
          (click)="toggleSound()"
          [class.enabled]="soundEnabled()"
          [title]="soundEnabled() ? 'Выключить звук' : 'Включить звук'">
          <svg *ngIf="soundEnabled()" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19.07 4.93C20.9447 6.80728 21.9979 9.34823 21.9979 12C21.9979 14.6518 20.9447 17.1927 19.07 19.07M15.54 8.46C16.4774 9.39764 17.0039 10.6692 17.0039 12C17.0039 13.3308 16.4774 14.6024 15.54 15.54" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <svg *ngIf="!soundEnabled()" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="23" y1="9" x2="17" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="17" y1="9" x2="23" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Chat Messages -->
    <div class="chat-messages">
      <div class="welcome-message" *ngIf="messages().length === 0">
        <div class="welcome-icon">
          <i class="fas fa-comments"></i>
        </div>
        <h3>Добро пожаловать!</h3>
        <p>Наша команда готова ответить на ваши вопросы о подборе автомобилей.</p>
        <div class="welcome-features">
          <div class="feature">
            <i class="fas fa-clock"></i>
            <span>Ответим в течение 5 минут</span>
          </div>
          <div class="feature">
            <i class="fas fa-shield-alt"></i>
            <span>Консультация бесплатно</span>
          </div>
          <div class="feature">
            <i class="fas fa-car"></i>
            <span>Подбор по вашим критериям</span>
          </div>
        </div>
      </div>

      <div 
        class="message" 
        *ngFor="let message of messages()"
        [class.client]="message.senderType === 'client'"
        [class.admin]="message.senderType === 'admin'">
        
        <!-- Аватар и имя админа (только для сообщений от админа) -->
        <div class="message-avatar" *ngIf="message.senderType === 'admin'">
          <div class="avatar-circle">
            {{ defaultAdminAvatar }}
          </div>
        </div>
        
        <div class="message-wrapper">
          <!-- Имя админа (только для сообщений от админа) -->
          <div class="message-sender" *ngIf="message.senderType === 'admin'">
            {{ defaultAdminName }}
          </div>
          
          <div class="message-content">
            <div class="message-text">{{ message.message }}</div>
            <div class="message-time">{{ formatTime(message.createdAt) }}</div>
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="typing-indicator" *ngIf="isTyping()">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span class="typing-text">Администратор печатает...</span>
      </div>
    </div>

    <!-- Chat Input -->
    <div class="chat-input">
      <div class="input-group">
        <input 
          type="text" 
          [(ngModel)]="newMessage"
          (keyup.enter)="sendMessage()"
          (input)="onTyping()"
          placeholder="Напишите ваш вопрос..."
          class="message-input"
          [disabled]="!isConnected()">
        <button 
          id="form-submit-btn"
          class="send-button" 
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || !isConnected()"
          title="Отправить сообщение">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Client Info Form (показывается только при первом сообщении) -->
    <div class="client-info" *ngIf="messages().length === 0">
      <div class="info-title">
        <i class="fas fa-user"></i>
        <span>Расскажите о себе</span>
      </div>
      <div class="info-fields">
        <input 
          type="text" 
          [(ngModel)]="clientName"
          (ngModelChange)="onNameChange()"
          placeholder="Ваше имя *"
          class="info-input"
          required>
        <input 
          type="email" 
          [(ngModel)]="clientEmail"
          (ngModelChange)="onEmailChange()"
          placeholder="Email (необязательно)"
          class="info-input">
        <input 
          type="tel" 
          [(ngModel)]="clientPhone"
          (ngModelChange)="onPhoneChange()"
          placeholder="Телефон *"
          class="info-input"
          required>
      </div>
    </div>
  </div>
</div>
